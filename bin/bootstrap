#!/bin/bash
set -eu

this_file="${BASH_SOURCE[0]}"
if ! [ -e "$this_file" ] ; then
  this_file="$(type -p "$this_file")"
fi
if ! [ -e "$this_file" ] ; then
  echo "Failed to resolve file."
  exit 1
fi
if ! [[ "$this_file" =~ ^/ ]] ; then
  this_file="$(pwd)/$this_file"
fi
while [ -h "$this_file" ] ; do
    ls_res="$(ls -ld "$this_file")"
    link_target=$(expr "$ls_res" : '.*-> \(.*\)$')
    if [[ "$link_target" =~ ^/ ]] ; then
      this_file="$link_target"
    else
      this_file="$(dirname "$this_file")/$link_target"
    fi
done
this_dir="$(dirname "$this_file")"
proj_root="${this_dir}/.."


select flavor in lite full ; do break ; done
if [ -z "${flavor:-}" ] ; then
  echo "flavor must be one of lite/full"
  exit 1
fi
flavor_suffix=".$flavor"

cp_safe() {
  local src=$1
  local dest=$2
  if [ -e "$src" ] ; then
    [ -e "$dest" ] && mv "$dest" "${dest}.$(date '+%Y-%m-%dT%H:%M:%S%z')"
  fi
  cp "$src" "$dest"
}

bashrc_file="${proj_root}/.bashrc"
bashrc_file_local="${proj_root}/.bashrc.local${flavor_suffix}"
ln -s "$bashrc_file" ~/.bashrc
test -e "$bashrc_file_local" && cp_safe "$_" ~/.bashrc.local

gitconfig_file="${proj_root}/gitconfig"
gitconfig_file_local="${proj_root}/gitconfig.local${flavor_suffix}"
ln -s "$gitconfig_file" ~/.gitconfig
test -e "$gitconfig_file_local" && cp_safe "$_" ~/.gitconfig.local

vimrc_file="${proj_root}/.vimrc"
vimrc_file_local="${proj_root}/.vimrc.local${flavor_suffix}"
ln -s "$vimrc_file" ~/.vimrc
test -e "$vimrc_file_local" && cp_safe "$_" ~/.vimrc.local
